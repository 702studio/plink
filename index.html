<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Plinko Pro — Tek HTML</title>
    <style>
      :root{
        --bg: #0b0f17; --fg:#e5e7eb; --line:#1f2430; --accent:#22d3ee; --accent2:#a78bfa; --win:#34d399; --loss:#f87171;
      }
      *{box-sizing:border-box}
      html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 50% 0%, #0e1422 0%, #0b0f17 40%, #080b12 100%);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .app{height:100%;display:grid;grid-template-rows:auto 1fr auto}
      .top{position:sticky;top:0;z-index:5;background:rgba(17,24,39,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:6px}
      .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
      .title{font-weight:800;letter-spacing:.3px;font-size:12px}
      .pill{border:1px solid var(--line);border-radius:999px;padding:3px 8px;background:#0c111b;font-size:10px}
      .controls{display:flex;gap:6px;flex-wrap:wrap}
      label{font-size:10px;opacity:.9}
      input,select,button{background:#121929;color:var(--fg);border:1px solid #2a2e39;border-radius:8px;height:22px;padding:4px 8px;font-size:12px}
      button{cursor:pointer;font-weight:700}
      button:active{transform:translateY(1px)}
      .main{padding:10px;min-height:0;display:grid;grid-template-columns:1fr;gap:10px}
      .board{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:linear-gradient(180deg, rgba(15,23,42,0.9), rgba(2,6,23,0.9));position:relative}
      canvas{display:block;width:100%;height:100%;touch-action:manipulation}
      .hud{position:absolute;top:10px;left:10px;display:flex;gap:8px;flex-wrap:wrap}
      .hud .badge{background:#0f172a;border:1px solid #24304a;color:#93c5fd;border-radius:8px;padding:6px 10px;font-size:12px}
      .footer{border-top:1px solid var(--line);background:#0f1626;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
      .note{font-size:12px;opacity:.7}
      .toast{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.4);border:1px solid #274060;padding:12px 16px;border-radius:12px;font-weight:800;letter-spacing:.5px;backdrop-filter:blur(6px);display:none}
      .toast.show{display:block;animation:pop .7s ease}
      @keyframes pop{0%{transform:translate(-50%,-50%) scale(.8);opacity:0}50%{opacity:1}100%{transform:translate(-50%,-50%) scale(1)}}
      @media (max-width: 520px){ .controls{gap:8px} .title{font-size:14px} }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <div class="title">Plinko Pro</div>
            <div class="pill">Bakiye: <span id="bal">100.00</span></div>
            <div class="pill">Son Kazanç: <span id="last">-</span></div>
          </div>
          <div class="controls">
            <label>Bahis <input id="bet" type="number" value="1" min="0.1" step="0.1" style="width:64px"></label>
            <label>Risk
              <select id="risk">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </label>
            <label>Satır <input id="rows" type="number" value="12" min="8" max="16" step="1" style="width:56px"></label>
            <label>Top <input id="balls" type="number" value="5" min="1" max="50" step="1" style="width:56px"></label>
            <button id="drop" style="padding:2px 8px;font-size:12px;border-radius:6px">Bırak</button>
            <button id="auto" style="padding:2px 8px;font-size:12px;border-radius:6px">Auto: Kapalı</button>
          </div>
        </div>
      </div>

      <div class="main">
        <div class="board">
          <div class="hud"></div>
          <canvas id="c"></canvas>
          <div id="toast" class="toast">+0.00</div>
        </div>
      </div>

      <div class="footer">
        <div class="note">Ekrana dokun/tıkla: top bırak. Çarpanlar riske göre dinamiktir. Demo — zincir dışı.</div>
        <div style="font-size:12px;opacity:.7">Tek HTML, vanilla JS</div>
      </div>
    </div>

    <script>
      // --- Elements & State ---
      const cvs = document.getElementById('c');
      const ctx = cvs.getContext('2d');
      const balEl = document.getElementById('bal');
      const lastEl = document.getElementById('last');
      const toast = document.getElementById('toast');
      const hud = document.querySelector('.hud');
      const elBet = document.getElementById('bet');
      const elRisk = document.getElementById('risk');
      const elRows = document.getElementById('rows');
      const elBalls = document.getElementById('balls');
      const btnDrop = document.getElementById('drop');
      const btnAuto = document.getElementById('auto');

      let W=0, H=0, dpr=1;
      let balance = 100;
      let rows = 12;
      let cols = rows + 1;
      let risk = 'medium';
      let bet = 1;
      let auto = false;
      let pins = []; // {x,y,r}
      let balls = []; // {x,y,vx,vy,r,trail:[],hue}
      let slots = []; // {x,w}
      let groundY = 0;
      let multipliers = [];
      let confetti = [];

      // --- Utils ---
      const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
      const rand=(a,b)=>Math.random()*(b-a)+a;
      const lerp=(a,b,t)=>a+(b-a)*t;
      const format=(n)=>n.toFixed(2);
      const BET_PER_BALL = 10; // her top maliyeti

      function gaussian(x, mean, sigma){
        const coeff = 1 / (sigma * Math.sqrt(2*Math.PI));
        const exponent = -((x-mean)**2) / (2*sigma**2);
        return coeff * Math.exp(exponent);
      }
      function binomialProbs(n){ const out=[]; let c=1; const norm=2**n; for(let k=0;k<=n;k++){ if(k>0){ c=c*(n-k+1)/k; } out.push(c/norm); } return out; }
      function buildMultipliers(rows, risk){
        const slots = rows + 1; const center = (slots-1)/2;
        const sigmaBase = Math.max(1.6, rows/4);
        const sigma = risk==='low'? sigmaBase*1.1 : risk==='medium'? sigmaBase*0.9 : sigmaBase*0.65;
        const maxEdge = risk==='high'? 9.0 : risk==='medium'? 5.0 : 3.0;
        const minCenter = risk==='high'? 0.15 : risk==='medium'? 0.20 : 0.35;
        const targetRTP = risk==='low'? 0.94 : risk==='medium'? 0.92 : 0.90;
        const maxG = gaussian(center, center, sigma);
        const shape=[]; for(let i=0;i<slots;i++){ const g=gaussian(i,center,sigma)/maxG; shape.push(1-g); }
        let arr = shape.map(s => minCenter + s * (maxEdge - minCenter));
        const p = binomialProbs(rows);
        const exp = arr.reduce((sum,m,i)=>sum + p[i]*m, 0);
        const scale = targetRTP / exp; arr = arr.map(m=> Number((m*scale).toFixed(2)));
        return arr;
      }

      // --- Layout ---
      function resize(){
        dpr = Math.min(2, window.devicePixelRatio||1);
        const board = cvs.parentElement.getBoundingClientRect();
        const targetH = Math.max(420, Math.min(window.innerHeight - 180, 760));
        cvs.style.height = targetH + 'px';
        cvs.width = Math.floor(board.width * dpr);
        cvs.height = Math.floor(targetH * dpr);
        cvs.style.width = Math.floor(cvs.width/dpr) + 'px';
        W = cvs.width; H = cvs.height;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        rebuildBoard();
      }

      function rebuildBoard(){
        rows = clamp(Number(elRows.value)||rows, 8, 16);
        cols = rows + 1;
        risk = elRisk.value;
        pins.length = 0; slots.length = 0; balls.length = 0; confetti.length=0;
        multipliers = buildMultipliers(rows, risk);

        const padX = 24, padYTop = 40, padYBottom = 140;
        const usableW = W/dpr - padX*2;
        const usableH = H/dpr - padYTop - padYBottom;
        const rowGap = usableH / rows;
        const colGap = usableW / (cols - 1);
        const pinR = 4;
        for(let r=0;r<rows;r++){
          for(let c=0;c<cols;c++){
            let x = padX + c*colGap + (r%2? colGap/2 : 0);
            if(x<padX || x>(W/dpr - padX)) continue;
            let y = padYTop + r*rowGap;
            pins.push({x,y,r:pinR});
          }
        }
        groundY = (H/dpr) - 60;
        const slotCount = cols;
        const slotW = usableW / slotCount;
        for(let i=0;i<slotCount;i++){
          slots.push({ x: padX + i*slotW, w: slotW });
        }
        // HUD multipliers
        hud.innerHTML = '';
        multipliers.forEach((m,i)=>{
          const b = document.createElement('div');
          b.className='badge'; b.textContent = i+': '+m+'x';
          hud.appendChild(b);
        });
      }

      // --- Physics ---
      function spawnBall(n=1){
        const count = clamp(Number(elBalls.value)||1, 1, 50);
        const total = n===1? count : n;
        const cost = BET_PER_BALL * total;
        if (balance < cost) { showToast('Bakiye yetersiz', 'warn'); return; }
        balance = Number((balance - cost).toFixed(2)); balEl.textContent = format(balance);
        for(let i=0;i<total;i++){
          const hue = Math.floor(rand(180, 320));
          balls.push({ x: rand(40, (W/dpr)-40), y: -10, vx: rand(-1,1), vy: 0, r: 7, trail:[], hue });
        }
      }

      function step(dt){
        const g = 980; // px/s^2
        const air = 0.995;
        const e = 0.75; // restitution
        const left = 0, right = (W/dpr), top = 0, bottom = groundY;
        for(let b of balls){
          // gravity
          b.vy += g * dt;
          b.vx *= air; b.vy *= air;

          // integrate
          b.x += b.vx * dt; b.y += b.vy * dt;

          // walls
          if(b.x - b.r < left){ b.x = left + b.r; b.vx = -b.vx * e; }
          if(b.x + b.r > right){ b.x = right - b.r; b.vx = -b.vx * e; }
          if(b.y - b.r < top){ b.y = top + b.r; b.vy = -b.vy * e; }

          // pin collisions (naive)
          for(let p of pins){
            const dx = b.x - p.x, dy = b.y - p.y;
            const dist2 = dx*dx + dy*dy; const R = b.r + p.r;
            if(dist2 < R*R){
              const dist = Math.sqrt(dist2) || 0.0001;
              const nx = dx/dist, ny = dy/dist; // normal
              // push out
              const overlap = R - dist;
              b.x += nx * overlap; b.y += ny * overlap;
              // reflect velocity
              const vn = b.vx*nx + b.vy*ny;
              const tx = -ny, ty = nx; // tangent
              const vt = b.vx*tx + b.vy*ty;
              const rvn = -vn * e;
              b.vx = rvn*nx + vt*tx + (Math.random()-0.5)*0.2;
              b.vy = rvn*ny + vt*ty + (Math.random()-0.5)*0.2;
            }
          }

          // ground/slots
          if(b.y + b.r >= bottom){
            // find slot
            const sIdx = Math.max(0, Math.min(slots.length-1, Math.floor((b.x - slots[0].x) / slots[0].w)));
            const mult = multipliers[sIdx] || 1;
            const win = BET_PER_BALL * mult;
            balance = Number((balance + win).toFixed(2));
            balEl.textContent = format(balance);
            lastEl.textContent = '+'+format(win)+' ('+mult+'x)';
            showToast('+'+format(win)+' ('+mult+'x)', mult>=3? 'big':'');
            if(mult>=3) spawnConfetti(b.x, bottom-10, mult);
            // remove ball
            b.remove = true;
          }

          // trail
          b.trail.push({x:b.x, y:b.y, a:1});
          if(b.trail.length>10) b.trail.shift();
        }
        balls = balls.filter(b=>!b.remove && b.y < (H/dpr)+40);

        // auto mode
        if(auto && Math.random()<0.15) spawnBall(1);

        // update confetti
        for(let p of confetti){ p.vy += 800*dt; p.vx *= 0.995; p.vy *= 0.995; p.x += p.vx*dt; p.y += p.vy*dt; p.rot += p.vr*dt; p.life -= dt; }
        confetti = confetti.filter(p=>p.life>0 && p.y < (H/dpr)+50);
      }

      function spawnConfetti(x,y,intensity){
        const n = Math.min(80, Math.floor(20*intensity));
        for(let i=0;i<n;i++){
          confetti.push({ x, y, vx: rand(-200,200), vy: rand(-300,-100), rot: rand(0,6.28), vr: rand(-6,6), life: rand(0.8,1.4), hue: Math.floor(rand(0,360)) });
        }
      }

      function showToast(text, kind){
        toast.textContent = text; toast.classList.add('show');
        toast.style.borderColor = kind==='big'? '#10b981' : '#274060';
        setTimeout(()=> toast.classList.remove('show'), 900);
      }

      // --- Render ---
      function render(){
        // clear
        ctx.clearRect(0,0,W,H);
        const vw = W/dpr, vh = H/dpr;

        // subtle vignette
        const grd = ctx.createRadialGradient(vw/2, 0, 60, vw/2, 0, Math.max(vw,vh));
        grd.addColorStop(0, 'rgba(167,139,250,0.05)');
        grd.addColorStop(1, 'rgba(2,6,23,0)');
        ctx.fillStyle = grd; ctx.fillRect(0,0,vw,vh);

        // glow pass
        ctx.save(); ctx.globalCompositeOperation = 'lighter';
        // pins
        for(let p of pins){
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r+1.2, 0, Math.PI*2);
          ctx.fillStyle = 'rgba(167,139,250,0.45)'; ctx.fill();
        }
        // slot lights baseline
        for(let i=0;i<slots.length;i++){
          const s = slots[i];
          const cx = s.x + s.w/2; const y = groundY-14; const intensity = multipliers[i]/Math.max(...multipliers);
          ctx.beginPath(); ctx.arc(cx, y, 10 + intensity*6, 0, Math.PI*2);
          ctx.fillStyle = `rgba(52,211,153, ${0.12 + intensity*0.18})`; ctx.fill();
        }
        ctx.restore();

        // grid bars
        ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 2;
        for(let i=0;i<=slots.length;i++){
          const s = slots[0]; const x = (i===0)? s.x : s.x + i*s.w;
          ctx.beginPath(); ctx.moveTo(x, groundY-24); ctx.lineTo(x, groundY-100); ctx.stroke();
        }
        // ground
        ctx.fillStyle = '#111827'; ctx.fillRect(0, groundY-6, vw, 12);

        // balls trails
        ctx.save(); ctx.globalCompositeOperation = 'lighter';
        for(let b of balls){
          for(let i=0;i<b.trail.length;i++){
            const t = b.trail[i]; const a = (i/b.trail.length)*0.5;
            ctx.fillStyle = `hsla(${b.hue}, 100%, 60%, ${a})`;
            ctx.beginPath(); ctx.arc(t.x, t.y, Math.max(1, 6*i/b.trail.length), 0, Math.PI*2); ctx.fill();
          }
        }
        ctx.restore();

        // balls
        for(let b of balls){
          ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
          ctx.fillStyle = `hsl(${b.hue}, 100%, 60%)`; ctx.fill();
          ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.stroke();
        }

        // confetti
        for(let p of confetti){
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
          ctx.fillStyle = `hsl(${p.hue},100%,60%)`; ctx.fillRect(-3,-1.5,6,3);
          ctx.restore();
        }
      }

      // --- Loop ---
      let last = performance.now();
      function loop(ts){
        const dt = Math.min(0.033, (ts-last)/1000); last = ts;
        step(dt); render();
        requestAnimationFrame(loop);
      }

      // --- Events ---
      new ResizeObserver(()=>resize()).observe(document.body);
      window.addEventListener('orientationchange', ()=>setTimeout(resize,150));
      cvs.addEventListener('click', ()=>spawnBall(1));
      cvs.addEventListener('touchstart', ()=>spawnBall(1), {passive:true});
      btnDrop.addEventListener('click', ()=>spawnBall(1));
      btnAuto.addEventListener('click', ()=>{ auto = !auto; btnAuto.textContent = 'Auto: ' + (auto?'Açık':'Kapalı'); });
      elRows.addEventListener('change', ()=>{ rebuildBoard(); });
      elRisk.addEventListener('change', ()=>{ rebuildBoard(); });

      // init
      resize();
      requestAnimationFrame(loop);
    </script>
  </body>
  </html>


